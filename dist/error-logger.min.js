/**
 * Error-Logger by Jerome Baudoux
 * http://www.jerome-baudoux.com
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>
 */
!function(window,document,undefined){"use strict";function ErrorLogger(){ErrorLogger.LOCALSTORAGE_PREFIX_KEY="LOGS_TO_KEEP",ErrorLogger.LOCALSTORAGE_INDEX_KEY="LOGS_INDEX",this.nbChunks=10,this.linesInChunks=100}ErrorLogger.getInstance=function(){return ErrorLogger.inst||(ErrorLogger.inst=new ErrorLogger),ErrorLogger.inst},ErrorLogger.prototype.setNbChunks=function(nbChunks){this.nbChunks=nbChunks},ErrorLogger.prototype.setLinesInChunks=function(nbLines){this.linesInChunks=nbLines},ErrorLogger.prototype.handleError=function(message,error,doNotShowInConsole){try{var line=this.formatLine(message);error&&error.stack&&(line+="\n"+error.stack),doNotShowInConsole||console.error(line),this.addToCurrentChunk(line)}catch(e){console.error(e.stack)}},ErrorLogger.prototype.getLogs=function(){try{var storage=this.getLocalStorage();if(storage){for(var index=this.getIndex(),content="",i=index.firstChunk;i<=index.currentChunk;i++){var item=storage.getItem(ErrorLogger.LOCALSTORAGE_PREFIX_KEY+i);item&&null!==item&&(content=content?content+"\n"+storage.getItem(ErrorLogger.LOCALSTORAGE_PREFIX_KEY+i):storage.getItem(ErrorLogger.LOCALSTORAGE_PREFIX_KEY+i))}return content}return"Your browser does not support Local storage"}catch(e){console.error(e.stack)}},ErrorLogger.prototype.clearLogs=function(){try{var storage=this.getLocalStorage();storage&&storage.clear()}catch(e){console.error(e.stack)}},ErrorLogger.prototype.getLocalStorage=function(){return"undefined"!=typeof Storage?window.localStorage:undefined},ErrorLogger.prototype.formatLine=function(line){var now=new Date,date=now.getFullYear()+"-"+("00"+now.getDate()).slice(-2)+"-"+("00"+(now.getMonth()+1)).slice(-2)+" "+("00"+now.getHours()).slice(-2)+":"+("00"+now.getMinutes()).slice(-2)+":"+("00"+now.getSeconds()).slice(-2);return date+" | "+line},ErrorLogger.prototype.createIndex=function(){return{firstChunk:0,currentChunk:0}},ErrorLogger.prototype.getIndex=function(){var index,storage=this.getLocalStorage();if(storage)try{var json=storage.getItem(ErrorLogger.LOCALSTORAGE_INDEX_KEY);json&&(index=JSON.parse(json))}catch(e){console.log("Log index cannot be found or is corrupted")}return index||(index=this.createIndex(),this.saveIndex(index)),index},ErrorLogger.prototype.saveIndex=function(index){var storage=this.getLocalStorage();if(storage)try{storage.setItem(ErrorLogger.LOCALSTORAGE_INDEX_KEY,JSON.stringify(index))}catch(e){console.log("Log index cannot be saved")}},ErrorLogger.prototype.countLines=function(line){return line?line.split("\n").length:0},ErrorLogger.prototype.removeOldLogs=function(index){var storage=this.getLocalStorage();if(storage)try{if(index.currentChunk-index.firstChunk>=this.nbChunks){for(var i=index.firstChunk;i<index.currentChunk-this.nbChunks;i++)storage.removeItem(ErrorLogger.LOCALSTORAGE_PREFIX_KEY+i);index.firstChunk=index.currentChunk-this.nbChunks+1}}catch(e){console.log("Could not clear logs")}},ErrorLogger.prototype.addToCurrentChunk=function(line){var index=this.getIndex(),storage=this.getLocalStorage();if(storage){var key=ErrorLogger.LOCALSTORAGE_PREFIX_KEY+index.currentChunk,content=storage.getItem(key),nbLines=this.countLines(content);nbLines>=this.linesInChunks&&(index.currentChunk++,this.removeOldLogs(index),this.saveIndex(index),content="",key=ErrorLogger.LOCALSTORAGE_PREFIX_KEY+index.currentChunk),content=content?content+"\n"+line:line,storage.setItem(key,content)}},window.ErrorLogger=ErrorLogger}(window,document);